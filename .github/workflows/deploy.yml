name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: 'false'
        type: boolean

jobs:
  test-before-deploy:
    name: Pre-deployment Tests
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.test_result.outputs.should_deploy }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'
        cache: true
        cache-dependency-path: go.sum

    - name: Install dependencies
      run: go mod download

    - name: Run tests
      id: run_tests
      continue-on-error: true
      run: |
        if make test; then
          echo "tests_passed=true" >> $GITHUB_OUTPUT
        else
          echo "tests_passed=false" >> $GITHUB_OUTPUT
        fi

    - name: Run race detection
      id: run_race_tests
      continue-on-error: true
      run: |
        if make test-race; then
          echo "race_tests_passed=true" >> $GITHUB_OUTPUT
        else
          echo "race_tests_passed=false" >> $GITHUB_OUTPUT
        fi

    - name: Build components
      id: build
      continue-on-error: true
      run: |
        if make build; then
          echo "build_passed=true" >> $GITHUB_OUTPUT
        else
          echo "build_passed=false" >> $GITHUB_OUTPUT
        fi

    - name: Determine deployment decision
      id: test_result
      run: |
        TESTS_PASSED="${{ steps.run_tests.outputs.tests_passed }}"
        RACE_TESTS_PASSED="${{ steps.run_race_tests.outputs.race_tests_passed }}"
        BUILD_PASSED="${{ steps.build.outputs.build_passed }}"
        FORCE_DEPLOY="${{ github.event.inputs.force_deploy }}"
        
        echo "Tests passed: $TESTS_PASSED"
        echo "Race tests passed: $RACE_TESTS_PASSED" 
        echo "Build passed: $BUILD_PASSED"
        echo "Force deploy: $FORCE_DEPLOY"
        
        if [[ "$TESTS_PASSED" == "true" && "$RACE_TESTS_PASSED" == "true" && "$BUILD_PASSED" == "true" ]]; then
          echo "âœ… All checks passed - deployment approved"
          echo "should_deploy=true" >> $GITHUB_OUTPUT
        elif [[ "$FORCE_DEPLOY" == "true" ]]; then
          echo "âš ï¸ Checks failed but force deployment requested"
          echo "should_deploy=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Checks failed - deployment blocked"
          echo "should_deploy=false" >> $GITHUB_OUTPUT
        fi

  notify-webhook:
    name: Trigger Server Deployment
    runs-on: ubuntu-latest
    needs: test-before-deploy
    if: needs.test-before-deploy.outputs.should_deploy == 'true'
    
    steps:
    - name: Connect to Tailscale
      uses: tailscale/github-action@v2
      with:
        authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
        
    - name: Trigger deployment webhook
      run: |
        echo "ğŸš€ Triggering deployment webhook..."
        echo "This will be handled automatically by GitHub's webhook system"
        echo "Your server should receive the webhook and start deployment"
        
        # Optional: Send a notification to your monitoring system
        if [[ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ğŸš€ Lightning Node Tools deployment started from GitHub Actions"}' \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
        fi

    - name: Wait for deployment
      run: |
        echo "â³ Waiting 30 seconds for deployment to process..."
        sleep 30

    - name: Check deployment status
      continue-on-error: true
      run: |
        # Optional: Check if your server is responding
        if [[ -n "${{ secrets.SERVER_URL }}" ]]; then
          echo "ğŸ” Checking server health after deployment..."
          if curl -f "${{ secrets.SERVER_URL }}/api/health" > /dev/null 2>&1; then
            echo "âœ… Server is responding correctly"
          else
            echo "âš ï¸ Server health check failed - may still be deploying"
          fi
        else
          echo "â„¹ï¸ No SERVER_URL configured for health check"
        fi

  deployment-failed:
    name: Handle Deployment Failure
    runs-on: ubuntu-latest
    needs: test-before-deploy
    if: needs.test-before-deploy.outputs.should_deploy == 'false'
    
    steps:
    - name: Notify deployment blocked
      run: |
        echo "ğŸš« Deployment blocked due to failed checks"
        echo "Fix the issues and push again, or use workflow_dispatch with force_deploy=true"
        
        # Optional: Send notification
        if [[ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ğŸš« Lightning Node Tools deployment blocked - tests failed"}' \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
        fi
        
        exit 1