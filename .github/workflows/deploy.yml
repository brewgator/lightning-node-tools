name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: 'false'
        type: boolean

jobs:
  test-before-deploy:
    name: Pre-deployment Tests
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.test_result.outputs.should_deploy }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'
        cache: true
        cache-dependency-path: go.sum

    - name: Install dependencies
      run: go mod download

    - name: Run tests
      id: run_tests
      continue-on-error: true
      run: |
        if make test; then
          echo "tests_passed=true" >> $GITHUB_OUTPUT
        else
          echo "tests_passed=false" >> $GITHUB_OUTPUT
        fi

    - name: Run race detection
      id: run_race_tests
      continue-on-error: true
      run: |
        if make test-race; then
          echo "race_tests_passed=true" >> $GITHUB_OUTPUT
        else
          echo "race_tests_passed=false" >> $GITHUB_OUTPUT
        fi

    - name: Build components
      id: build
      continue-on-error: true
      run: |
        if make build; then
          echo "build_passed=true" >> $GITHUB_OUTPUT
        else
          echo "build_passed=false" >> $GITHUB_OUTPUT
        fi

    - name: Determine deployment decision
      id: test_result
      run: |
        TESTS_PASSED="${{ steps.run_tests.outputs.tests_passed }}"
        RACE_TESTS_PASSED="${{ steps.run_race_tests.outputs.race_tests_passed }}"
        BUILD_PASSED="${{ steps.build.outputs.build_passed }}"
        FORCE_DEPLOY="${{ github.event.inputs.force_deploy }}"

        echo "Tests passed: $TESTS_PASSED"
        echo "Race tests passed: $RACE_TESTS_PASSED"
        echo "Build passed: $BUILD_PASSED"
        echo "Force deploy: $FORCE_DEPLOY"

        if [[ "$TESTS_PASSED" == "true" && "$RACE_TESTS_PASSED" == "true" && "$BUILD_PASSED" == "true" ]]; then
          echo "‚úÖ All checks passed - deployment approved"
          echo "should_deploy=true" >> $GITHUB_OUTPUT
        elif [[ "$FORCE_DEPLOY" == "true" ]]; then
          echo "‚ö†Ô∏è Checks failed but force deployment requested"
          echo "should_deploy=true" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Checks failed - deployment blocked"
          echo "should_deploy=false" >> $GITHUB_OUTPUT
        fi

  notify-webhook:
    name: Trigger Server Deployment
    runs-on: ubuntu-latest
    needs: test-before-deploy
    if: needs.test-before-deploy.outputs.should_deploy == 'true'

    steps:
    - name: Connect to Tailscale
      uses: tailscale/github-action@v2
      with:
        authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

    - name: Trigger deployment webhook
      run: |
        echo "üöÄ Triggering deployment webhook..."
        # Create a fake GitHub webhook payload
        payload=$(cat <<EOF
        {
          "ref": "refs/heads/main",
          "repository": {
            "name": "lightning-node-tools",
            "full_name": "brewgator/lightning-node-tools"
          },
          "head_commit": {
            "id": "${{ github.sha }}",
            "message": "${{ github.event.head_commit.message }}",
            "author": {
              "name": "${{ github.actor }}",
              "email": "noreply@github.com"
            }
          }
        }
        EOF
        )

        # Calculate HMAC signature
        signature="sha256=$(echo -n "$payload" | openssl dgst -sha256 -hmac "${{ secrets.WEBHOOK_SECRET }}" | cut -d' ' -f2)"

        # Send webhook to server
        curl -X POST -H "Content-Type: application/json" \
             -H "X-Hub-Signature-256: $signature" \
             -d "$payload" \
             "${{ secrets.WEBHOOK_URL }}"

        # Optional: Send a notification to your monitoring system
        if [[ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"üöÄ Lightning Node Tools deployment started from GitHub Actions"}' \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
        fi

    - name: Wait for deployment
      run: |
        echo "‚è≥ Waiting 30 seconds for deployment to process..."
        sleep 30

    - name: Check deployment status
      continue-on-error: true
      run: |
        # Optional: Check if your server is responding
        if [[ -n "${{ secrets.SERVER_URL }}" ]]; then
          echo "üîç Checking server health after deployment..."
          if curl -f "${{ secrets.SERVER_URL }}/api/health" > /dev/null 2>&1; then
            echo "‚úÖ Server is responding correctly"
          else
            echo "‚ö†Ô∏è Server health check failed - may still be deploying"
          fi
        else
          echo "‚ÑπÔ∏è No SERVER_URL configured for health check"
        fi

  deployment-failed:
    name: Handle Deployment Failure
    runs-on: ubuntu-latest
    needs: test-before-deploy
    if: needs.test-before-deploy.outputs.should_deploy == 'false'

    steps:
    - name: Notify deployment blocked
      run: |
        echo "üö´ Deployment blocked due to failed checks"
        echo "Fix the issues and push again, or use workflow_dispatch with force_deploy=true"

        # Optional: Send notification
        if [[ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"üö´ Lightning Node Tools deployment blocked - tests failed"}' \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
        fi

        exit 1
