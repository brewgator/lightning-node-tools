<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Portfolio Dashboard</title>
    <!-- Chart.js CDN - using older stable version for better compatibility -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            color: #f0883e;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #8b949e;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }

        .card h2 {
            color: #f0883e;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #30363d;
        }

        .balance-item:last-child {
            border-bottom: none;
        }

        .balance-label {
            color: #8b949e;
        }

        .balance-value {
            color: #c9d1d9;
            font-weight: 600;
        }

        .total {
            font-size: 1.2em;
            color: #f0883e !important;
        }

        .status {
            text-align: center;
            padding: 20px;
            color: #8b949e;
        }

        .loading {
            color: #f0883e;
        }

        .error {
            color: #f85149;
        }

        .chart-container {
            position: relative;
            height: 300px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 10px;
        }

        .chart-container canvas {
            max-height: 100%;
            max-width: 100%;
        }

        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8b949e;
            text-align: center;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .refresh-btn {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
        }

        .refresh-btn:hover {
            background: #2ea043;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° Bitcoin Portfolio Dashboard</h1>
            <p class="subtitle">Real-time Lightning & On-chain Balance Tracking</p>
        </header>

        <div id="status" class="status loading">Loading portfolio data...</div>

        <div id="dashboard" style="display: none;">
            <div class="grid">
                <div class="card">
                    <h2>üí∞ Current Portfolio</h2>
                    <div id="current-balances">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="card">
                    <h2>‚ö° Lightning Network</h2>
                    <div id="lightning-details">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="card">
                    <h2>üîó On-chain</h2>
                    <div id="onchain-details">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìà Portfolio History (30 days)</h2>
                <div class="chart-container">
                    <canvas id="portfolioChart"></canvas>
                </div>
            </div>

            <div class="charts-grid">
                <div class="card">
                    <h2>‚ö° Lightning Fees Earned</h2>
                    <div class="chart-container">
                        <canvas id="feesChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>üîÄ Forward Counts</h2>
                    <div class="chart-container">
                        <canvas id="forwardsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <button class="refresh-btn" id="refreshBtn" aria-label="Refresh portfolio data">üîÑ Refresh Data</button>
    </div>

    <script>
        // Global variables for chart instances
        let portfolioChart = null;
        let feesChart = null;
        let forwardsChart = null;

        // Dark theme configuration for Chart.js
        const darkTheme = {
            backgroundColor: '#0d1117',
            borderColor: '#30363d',
            textColor: '#c9d1d9',
            gridColor: '#21262d',
            accentColor: '#f0883e',
            successColor: '#238636',
            warningColor: '#d29922',
        };

        // Initialize Chart.js configuration when available
        function initializeChartDefaults() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js failed to load');
                return false;
            }

            // Chart.js v3 default configuration
            Chart.defaults.color = darkTheme.textColor;
            Chart.defaults.borderColor = darkTheme.gridColor;
            Chart.defaults.backgroundColor = darkTheme.backgroundColor;
            Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';

            console.log('Chart.js initialized successfully');
            return true;
        }

        function formatSats(sats) {
            if (sats >= 100000000) {
                return (sats / 100000000).toFixed(2) + ' BTC';
            }
            return sats.toLocaleString() + ' sats';
        }

        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        function showError(message) {
            const status = document.getElementById('status');
            status.className = 'status error';
            status.textContent = `‚ùå Error: ${message}`;
            document.getElementById('dashboard').style.display = 'none';
        }

        function showLoading() {
            const status = document.getElementById('status');
            status.className = 'status loading';
            status.textContent = '‚è≥ Loading portfolio data...';
            document.getElementById('dashboard').style.display = 'none';
        }

        function updateCurrentBalances(data) {
            const container = document.getElementById('current-balances');
            container.innerHTML = `
                <div class="balance-item">
                    <span class="balance-label">Total Portfolio:</span>
                    <span class="balance-value total">${formatSats(data.total_portfolio)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Total Liquid:</span>
                    <span class="balance-value">${formatSats(data.total_liquid)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Cold Storage:</span>
                    <span class="balance-value">${formatSats(data.cold_storage)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Last Updated:</span>
                    <span class="balance-value">${formatTimestamp(data.timestamp)}</span>
                </div>
            `;
        }

        function updateLightningDetails(data) {
            const container = document.getElementById('lightning-details');
            const total = data.lightning_local + data.lightning_remote;
            const localPercent = total > 0 ? ((data.lightning_local / total) * 100).toFixed(1) : 0;

            container.innerHTML = `
                <div class="balance-item">
                    <span class="balance-label">Total Capacity:</span>
                    <span class="balance-value">${formatSats(total)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Local Balance:</span>
                    <span class="balance-value">${formatSats(data.lightning_local)} (${localPercent}%)</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Remote Balance:</span>
                    <span class="balance-value">${formatSats(data.lightning_remote)}</span>
                </div>
            `;
        }

        function updateOnchainDetails(data) {
            const container = document.getElementById('onchain-details');
            const total = data.onchain_confirmed + data.onchain_unconfirmed + data.tracked_addresses;

            container.innerHTML = `
                <div class="balance-item">
                    <span class="balance-label">Total On-chain:</span>
                    <span class="balance-value">${formatSats(total)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Confirmed:</span>
                    <span class="balance-value">${formatSats(data.onchain_confirmed)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Unconfirmed:</span>
                    <span class="balance-value">${formatSats(data.onchain_unconfirmed)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Tracked Addresses:</span>
                    <span class="balance-value">${formatSats(data.tracked_addresses)}</span>
                </div>
            `;
        }

        // Chart 1: Portfolio Balance History (Line Chart)
        async function createPortfolioChart() {
            try {
                const response = await fetch('/api/portfolio/history?days=30');
                const result = await response.json();

                if (!result.success || !result.data || result.data.length === 0) {
                    return;
                }

                const ctx = document.getElementById('portfolioChart').getContext('2d');

                // Prepare data
                const labels = result.data.map(item => new Date(item.timestamp).toLocaleDateString());
                const portfolioData = result.data.map(item => item.total_portfolio);
                const liquidData = result.data.map(item => item.total_liquid);

                // Destroy existing chart
                if (portfolioChart) {
                    portfolioChart.destroy();
                }

                portfolioChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Portfolio',
                            data: portfolioData,
                            borderColor: darkTheme.accentColor,
                            backgroundColor: darkTheme.accentColor + '20',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                        }, {
                            label: 'Liquid (No Cold Storage)',
                            data: liquidData,
                            borderColor: darkTheme.successColor,
                            backgroundColor: darkTheme.successColor + '20',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: darkTheme.gridColor,
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatSats(value);
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: darkTheme.gridColor,
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                backgroundColor: darkTheme.borderColor,
                                titleColor: darkTheme.textColor,
                                bodyColor: darkTheme.textColor,
                                borderColor: darkTheme.gridColor,
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${formatSats(context.parsed.y)}`;
                                    }
                                }
                            },
                            legend: {
                                labels: {
                                    color: darkTheme.textColor,
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart',
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load portfolio chart:', error);
            }
        }

        // Chart 2: Lightning Fees (Bar + Line Combo)
        async function createFeesChart() {
            try {
                const response = await fetch('/api/lightning/fees?days=30');
                const result = await response.json();

                if (!result.success || !result.data) {
                    return;
                }

                const ctx = document.getElementById('feesChart').getContext('2d');

                // Prepare data
                const chartData = result.data;
                const labels = chartData.labels || [];
                const dailyFees = chartData.datasets?.[0]?.data || [];

                // Calculate cumulative fees
                let cumulative = 0;
                const cumulativeFees = dailyFees.map(fee => cumulative += fee);

                // Destroy existing chart
                if (feesChart) {
                    feesChart.destroy();
                }

                feesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Daily Fees (sats)',
                            data: dailyFees,
                            backgroundColor: darkTheme.accentColor + '80',
                            borderColor: darkTheme.accentColor,
                            borderWidth: 1,
                            yAxisID: 'y',
                        }, {
                            label: 'Cumulative Fees',
                            data: cumulativeFees,
                            type: 'line',
                            borderColor: darkTheme.successColor,
                            backgroundColor: darkTheme.successColor + '20',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                grid: {
                                    color: darkTheme.gridColor,
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + ' sats';
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false,
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatSats(value);
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: darkTheme.gridColor,
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                backgroundColor: darkTheme.borderColor,
                                titleColor: darkTheme.textColor,
                                bodyColor: darkTheme.textColor,
                                borderColor: darkTheme.gridColor,
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            return `Daily Fees: ${context.parsed.y} sats`;
                                        } else {
                                            return `Cumulative: ${formatSats(context.parsed.y)}`;
                                        }
                                    }
                                }
                            },
                            legend: {
                                labels: {
                                    color: darkTheme.textColor,
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart',
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load fees chart:', error);
            }
        }

        // Chart 3: Forward Counts (Bar Chart)
        async function createForwardsChart() {
            try {
                const response = await fetch('/api/lightning/forwards?days=30');
                const result = await response.json();

                if (!result.success || !result.data) {
                    return;
                }

                const ctx = document.getElementById('forwardsChart').getContext('2d');

                // Prepare data
                const chartData = result.data;
                const labels = chartData.labels || [];
                const forwardCounts = chartData.datasets?.[0]?.data || [];

                // Find high-volume days (above 75th percentile)
                const sorted = [...forwardCounts].sort((a, b) => a - b);
                const q3Index = Math.floor(sorted.length * 0.75);
                const highVolumeThreshold = sorted[q3Index] || 0;

                // Color bars based on volume
                const backgroundColors = forwardCounts.map(count =>
                    count >= highVolumeThreshold ? darkTheme.warningColor + '80' : darkTheme.accentColor + '80'
                );
                const borderColors = forwardCounts.map(count =>
                    count >= highVolumeThreshold ? darkTheme.warningColor : darkTheme.accentColor
                );

                // Destroy existing chart
                if (forwardsChart) {
                    forwardsChart.destroy();
                }

                forwardsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Forward Count',
                            data: forwardCounts,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: darkTheme.gridColor,
                                },
                                ticks: {
                                    stepSize: 1,
                                }
                            },
                            x: {
                                grid: {
                                    color: darkTheme.gridColor,
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                backgroundColor: darkTheme.borderColor,
                                titleColor: darkTheme.textColor,
                                bodyColor: darkTheme.textColor,
                                borderColor: darkTheme.gridColor,
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const count = context.parsed.y;
                                        const isHighVolume = count >= highVolumeThreshold;
                                        return `Forwards: ${count}${isHighVolume ? ' (High Volume)' : ''}`;
                                    }
                                }
                            },
                            legend: {
                                labels: {
                                    color: darkTheme.textColor,
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart',
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load forwards chart:', error);
            }
        }

        async function loadPortfolioData() {
            showLoading();

            // Initialize Chart.js if not already done
            if (!initializeChartDefaults()) {
                showError('Chart.js library failed to load');
                return;
            }

            try {
                const response = await fetch('/api/portfolio/current');
                const result = await response.json();

                if (!result.success) {
                    showError(result.error || 'Failed to load portfolio data');
                    return;
                }

                const data = result.data;

                // Update all sections
                updateCurrentBalances(data);
                updateLightningDetails(data);
                updateOnchainDetails(data);

                // Load charts
                await Promise.all([
                    createPortfolioChart(),
                    createFeesChart(),
                    createForwardsChart()
                ]);

                // Hide status and show dashboard
                document.getElementById('status').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

            } catch (error) {
                showError(`Network error: ${error.message}`);
            }
        }

        // Load data when page loads and set up event handlers
        document.addEventListener('DOMContentLoaded', function() {
            loadPortfolioData();
            document.getElementById('refreshBtn').addEventListener('click', loadPortfolioData);
            startAutoRefresh();
        });

        // Auto-refresh every 5 minutes, with visibility and unload management
        let refreshIntervalId = null;
        const REFRESH_INTERVAL_MS = 5 * 60 * 1000;

        function startAutoRefresh() {
            if (!refreshIntervalId) {
                refreshIntervalId = setInterval(loadPortfolioData, REFRESH_INTERVAL_MS);
            }
        }

        function stopAutoRefresh() {
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
            }
        }

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                loadPortfolioData();
                startAutoRefresh();
            }
        });

        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</body>
</html>
