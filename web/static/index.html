<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Portfolio Dashboard</title>
    <!-- Chart.js CDN - using older stable version for better compatibility -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            color: #f0883e;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #8b949e;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.95em;
            transition: all 0.2s ease;
        }

        .nav-tab:hover {
            background: #30363d;
            border-color: #484f58;
            color: #f0f6fc;
        }

        .nav-tab.active {
            background: #f0883e;
            color: #0d1117;
            border-color: #f0883e;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        @media (min-width: 1200px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }

        .card h2 {
            color: #f0883e;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #30363d;
        }

        .balance-item:last-child {
            border-bottom: none;
        }

        .balance-label {
            color: #8b949e;
        }

        .balance-value {
            color: #c9d1d9;
            font-weight: 600;
        }

        .total {
            font-size: 1.2em;
            color: #f0883e !important;
        }

        .status {
            text-align: center;
            padding: 20px;
            color: #8b949e;
        }

        .loading {
            color: #f0883e;
        }

        .error {
            color: #f85149;
        }

        .chart-container {
            position: relative;
            height: 300px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 10px;
        }

        .chart-container canvas {
            max-height: 100%;
            max-width: 100%;
        }

        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8b949e;
            text-align: center;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .refresh-btn {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
        }

        .refresh-btn:hover {
            background: #2ea043;
        }

        .date-range-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .date-range-label {
            color: #8b949e;
            font-size: 0.9em;
            margin-right: 5px;
        }

        .date-range-btn {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .date-range-btn:hover {
            background: #30363d;
            border-color: #484f58;
        }

        .date-range-btn.active {
            background: #f0883e;
            color: #0d1117;
            border-color: #f0883e;
        }

        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #f0883e;
            font-size: 0.9em;
            z-index: 10;
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .date-range-selector {
                flex-wrap: wrap;
                justify-content: center;
                gap: 5px;
            }

            .date-range-label {
                width: 100%;
                text-align: center;
                margin-bottom: 5px;
            }

            .date-range-btn {
                flex: 1;
                min-width: 60px;
                text-align: center;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° Bitcoin Portfolio Dashboard</h1>
            <p class="subtitle">Real-time Lightning & On-chain Balance Tracking</p>

            <div class="nav-tabs" role="tablist">
                <button type="button"
                        id="tab-dashboard"
                        class="nav-tab active"
                        role="tab"
                        aria-selected="true"
                        aria-controls="dashboard"
                        onclick="showSection('dashboard', event)">
                    üìä Portfolio Overview
                </button>
                <button type="button"
                        id="tab-lightning"
                        class="nav-tab"
                        role="tab"
                        aria-selected="false"
                        aria-controls="lightning"
                        onclick="showSection('lightning', event)">
                    ‚ö° Lightning Details
                </button>
                <button type="button"
                        id="tab-onchain"
                        class="nav-tab"
                        role="tab"
                        aria-selected="false"
                        aria-controls="onchain"
                        onclick="showSection('onchain', event)">
                    üîó On-chain Management
                </button>
                <button type="button"
                        id="tab-offline"
                        class="nav-tab"
                        role="tab"
                        aria-selected="false"
                        aria-controls="offline"
                        onclick="showSection('offline', event)">
                    üßä Cold Storage
                </button>
                <button type="button"
                        id="tab-analytics"
                        class="nav-tab"
                        role="tab"
                        aria-selected="false"
                        aria-controls="analytics"
                        onclick="showSection('analytics', event)">
                    üìà Analytics
                </button>
            </div>
        </header>

        <div id="status" class="status loading">Loading portfolio data...</div>

        <div id="dashboard" style="display: none;">
            <div class="grid">
                <div class="card">
                    <h2>üí∞ Current Portfolio</h2>
                    <div id="current-balances">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="card">
                    <h2>‚ö° Lightning Network</h2>
                    <div id="lightning-details">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="card">
                    <h2>üîó On-chain</h2>
                    <div id="onchain-details">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="card">
                    <h2>üßä Cold Storage</h2>
                    <div id="cold-storage-details">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìà Portfolio History</h2>
                <div class="date-range-selector portfolio-range">
                    <span class="date-range-label">Time Range:</span>
                    <button class="date-range-btn portfolio-range" data-days="7">7D</button>
                    <button class="date-range-btn portfolio-range active" data-days="30">30D</button>
                    <button class="date-range-btn portfolio-range" data-days="90">90D</button>
                    <button class="date-range-btn portfolio-range" data-days="365">1Y</button>
                    <button class="date-range-btn portfolio-range" data-days="all">ALL</button>
                </div>
                <div class="chart-container">
                    <div class="chart-loading" id="portfolioChartLoading">‚è≥ Loading chart data...</div>
                    <canvas id="portfolioChart"></canvas>
                </div>
            </div>

            <div class="charts-grid">
                <div class="card">
                    <h2>‚ö° Lightning Fees Earned</h2>
                    <div class="date-range-selector fees-range">
                        <span class="date-range-label">Time Range:</span>
                        <button class="date-range-btn fees-range" data-days="7">7D</button>
                        <button class="date-range-btn fees-range active" data-days="30">30D</button>
                        <button class="date-range-btn fees-range" data-days="90">90D</button>
                        <button class="date-range-btn fees-range" data-days="365">1Y</button>
                        <button class="date-range-btn fees-range" data-days="all">ALL</button>
                    </div>
                    <div class="chart-container">
                        <div class="chart-loading" id="feesChartLoading">‚è≥ Loading chart data...</div>
                        <canvas id="feesChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>üîÄ Forward Counts</h2>
                    <div class="date-range-selector forwards-range">
                        <span class="date-range-label">Time Range:</span>
                        <button class="date-range-btn forwards-range" data-days="7">7D</button>
                        <button class="date-range-btn forwards-range active" data-days="30">30D</button>
                        <button class="date-range-btn forwards-range" data-days="90">90D</button>
                        <button class="date-range-btn forwards-range" data-days="365">1Y</button>
                        <button class="date-range-btn forwards-range" data-days="all">ALL</button>
                    </div>
                    <div class="chart-container">
                        <div class="chart-loading" id="forwardsChartLoading">‚è≥ Loading chart data...</div>
                        <canvas id="forwardsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <button class="refresh-btn" id="refreshBtn" aria-label="Refresh portfolio data">üîÑ Refresh Data</button>
    </div>

    <script>
        // Global variables for chart instances
        let portfolioChart = null;
        let feesChart = null;
        let forwardsChart = null;

        // Global variables for date ranges
        let currentPortfolioRange = 30;
        let currentFeesRange = 30;
        let currentForwardsRange = 30;

        // LocalStorage keys
        const STORAGE_KEYS = {
            PORTFOLIO_RANGE: 'portfolio_date_range',
            FEES_RANGE: 'fees_date_range',
            FORWARDS_RANGE: 'forwards_date_range'
        };

        // Load date ranges from localStorage
        function loadDateRangesFromStorage() {
            const portfolioVal = localStorage.getItem(STORAGE_KEYS.PORTFOLIO_RANGE);
            const feesVal = localStorage.getItem(STORAGE_KEYS.FEES_RANGE);
            const forwardsVal = localStorage.getItem(STORAGE_KEYS.FORWARDS_RANGE);

            currentPortfolioRange = portfolioVal === 'all' ? 'all' : (parseInt(portfolioVal) || 30);
            currentFeesRange = feesVal === 'all' ? 'all' : (parseInt(feesVal) || 30);
            currentForwardsRange = forwardsVal === 'all' ? 'all' : (parseInt(forwardsVal) || 30);
        }

        // Save date range to localStorage
        function saveDateRangeToStorage(key, value) {
            localStorage.setItem(key, value);
        }

        // Update active button state
        function updateActiveButton(chartType, days) {
            let selector;
            if (chartType === 'portfolio') {
                selector = '.portfolio-range';
            } else if (chartType === 'fees') {
                selector = '.card .fees-range';
            } else if (chartType === 'forwards') {
                selector = '.card .forwards-range';
            }

            // Remove active class from all buttons in the selector group
            document.querySelectorAll(`${selector} .date-range-btn`).forEach(btn => {
                btn.classList.remove('active');
            });

            // Add active class to the clicked button
            const activeBtn = document.querySelector(`${selector} .date-range-btn[data-days="${days}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        // Dark theme configuration for Chart.js
        const darkTheme = {
            backgroundColor: '#0d1117',
            borderColor: '#30363d',
            textColor: '#c9d1d9',
            gridColor: '#21262d',
            accentColor: '#f0883e',
            successColor: '#238636',
            warningColor: '#d29922',
        };

        // Initialize Chart.js configuration when available
        function initializeChartDefaults() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js failed to load');
                return false;
            }

            // Chart.js v3 default configuration
            Chart.defaults.color = darkTheme.textColor;
            Chart.defaults.borderColor = darkTheme.gridColor;
            Chart.defaults.backgroundColor = darkTheme.backgroundColor;
            Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';

            console.log('Chart.js initialized successfully');
            return true;
        }

        function formatSats(sats) {
            if (sats >= 100000000) {
                return (sats / 100000000).toFixed(2) + ' BTC';
            }
            return sats.toLocaleString() + ' sats';
        }

        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        // Calculate portfolio components based on our portfolio rules
        // Note: lightning_remote is NOT part of our portfolio, only lightning_local counts
        function calculatePortfolioComponents(data) {
            return {
                lightning: data.lightning_local, // Only local balance belongs to us
                onchain: data.onchain_confirmed + data.onchain_unconfirmed + data.tracked_addresses,
                cold: data.cold_storage
            };
        }

        function showError(message) {
            const status = document.getElementById('status');
            status.className = 'status error';
            status.textContent = `‚ùå Error: ${message}`;
            document.getElementById('dashboard').style.display = 'none';
        }

        function showLoading() {
            const status = document.getElementById('status');
            status.className = 'status loading';
            status.textContent = '‚è≥ Loading portfolio data...';
            document.getElementById('dashboard').style.display = 'none';
        }

        function updateCurrentBalances(data) {
            const container = document.getElementById('current-balances');
            const total = data.total_portfolio;

            // Calculate percentages for each source (based on actual portfolio calculation)
            const components = calculatePortfolioComponents(data);
            const lightningTotal = components.lightning;
            const onchainTotal = components.onchain;
            const coldTotal = components.cold;

            const lightningPercent = total > 0 ? ((lightningTotal / total) * 100).toFixed(1) : 0;
            const onchainPercent = total > 0 ? ((onchainTotal / total) * 100).toFixed(1) : 0;
            const coldPercent = total > 0 ? ((coldTotal / total) * 100).toFixed(1) : 0;

            container.innerHTML = `
                <div class="balance-item">
                    <span class="balance-label">Total Portfolio:</span>
                    <span class="balance-value total">${formatSats(total)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">‚ö° Lightning (${lightningPercent}%):</span>
                    <span class="balance-value">${formatSats(lightningTotal)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">üîó On-chain (${onchainPercent}%):</span>
                    <span class="balance-value">${formatSats(onchainTotal)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">üßä Cold Storage (${coldPercent}%):</span>
                    <span class="balance-value">${formatSats(coldTotal)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">üíß Liquid (No Cold):</span>
                    <span class="balance-value">${formatSats(data.total_liquid)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Last Updated:</span>
                    <span class="balance-value">${formatTimestamp(data.timestamp)}</span>
                </div>
            `;
        }

        function updateLightningDetails(data) {
            const container = document.getElementById('lightning-details');
            const total = data.lightning_local + data.lightning_remote;
            const localPercent = total > 0 ? ((data.lightning_local / total) * 100).toFixed(1) : 0;
            const remotePercent = total > 0 ? ((data.lightning_remote / total) * 100).toFixed(1) : 0;

            container.innerHTML = `
                <div class="balance-item">
                    <span class="balance-label">Total Capacity:</span>
                    <span class="balance-value">${formatSats(total)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">üíß My Balance (${localPercent}%):</span>
                    <span class="balance-value">${formatSats(data.lightning_local)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">üîí Remote Balance (${remotePercent}%):</span>
                    <span class="balance-value" style="color: #8b949e;">${formatSats(data.lightning_remote)} (not mine)</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Portfolio %:</span>
                    <span class="balance-value">${data.total_portfolio > 0 ? ((data.lightning_local / data.total_portfolio) * 100).toFixed(1) : 0}% of total</span>
                </div>
            `;
        }

        function updateOnchainDetails(data) {
            const container = document.getElementById('onchain-details');
            const total = data.onchain_confirmed + data.onchain_unconfirmed + data.tracked_addresses;
            const confirmedPercent = total > 0 ? ((data.onchain_confirmed / total) * 100).toFixed(1) : 0;
            const unconfirmedPercent = total > 0 ? ((data.onchain_unconfirmed / total) * 100).toFixed(1) : 0;
            const trackedPercent = total > 0 ? ((data.tracked_addresses / total) * 100).toFixed(1) : 0;

            container.innerHTML = `
                <div class="balance-item">
                    <span class="balance-label">Total On-chain:</span>
                    <span class="balance-value">${formatSats(total)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">‚úÖ Confirmed (${confirmedPercent}%):</span>
                    <span class="balance-value">${formatSats(data.onchain_confirmed)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">‚è≥ Unconfirmed (${unconfirmedPercent}%):</span>
                    <span class="balance-value">${formatSats(data.onchain_unconfirmed)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">üëÅÔ∏è Tracked Addresses (${trackedPercent}%):</span>
                    <span class="balance-value">${formatSats(data.tracked_addresses)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Portfolio %:</span>
                    <span class="balance-value">${data.total_portfolio > 0 ? ((total / data.total_portfolio) * 100).toFixed(1) : 0}% of total</span>
                </div>
            `;
        }

        function updateColdStorageDetails(data) {
            const container = document.getElementById('cold-storage-details');
            const coldTotal = data.cold_storage;
            const portfolioPercent = data.total_portfolio > 0 ? ((coldTotal / data.total_portfolio) * 100).toFixed(1) : 0;

            container.innerHTML = `
                <div class="balance-item">
                    <span class="balance-label">‚ùÑÔ∏è Total Cold Storage:</span>
                    <span class="balance-value">${formatSats(coldTotal)}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Portfolio %:</span>
                    <span class="balance-value">${portfolioPercent}% of total</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Security Status:</span>
                    <span class="balance-value" style="color: #238636;">üîí Cold (Offline)</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Liquidity:</span>
                    <span class="balance-value" style="color: #d29922;">‚ö†Ô∏è Manual verification required</span>
                </div>
            `;
        }

        // Show/hide loading indicator
        function showChartLoading(chartId) {
            const loadingEl = document.getElementById(`${chartId}Loading`);
            if (loadingEl) {
                loadingEl.style.display = 'block';
            }
        }

        function hideChartLoading(chartId) {
            const loadingEl = document.getElementById(`${chartId}Loading`);
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
        }

        // Chart 1: Portfolio Balance History (Line Chart)
        async function createPortfolioChart() {
            try {
                showChartLoading('portfolioChart');

                const daysParam = currentPortfolioRange === 'all' ? '?days=all' : `?days=${currentPortfolioRange}`;
                const response = await fetch(`/api/portfolio/history${daysParam}`);
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
                }
                const result = await response.json();

                if (!result.success || !result.data || result.data.length === 0) {
                    hideChartLoading('portfolioChart');
                    console.error('No portfolio history data available:', result.error || 'Empty dataset');
                    return;
                }

                const ctx = document.getElementById('portfolioChart').getContext('2d');

                // Prepare data
                const labels = result.data.map(item => new Date(item.timestamp).toLocaleDateString());
                const portfolioData = result.data.map(item => item.total_portfolio);
                const liquidData = result.data.map(item => item.total_liquid);
                const lightningData = result.data.map(item => calculatePortfolioComponents(item).lightning);
                const onchainData = result.data.map(item => calculatePortfolioComponents(item).onchain);
                const coldData = result.data.map(item => calculatePortfolioComponents(item).cold);

                // Destroy existing chart
                if (portfolioChart) {
                    portfolioChart.destroy();
                }

                portfolioChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Portfolio',
                            data: portfolioData,
                            borderColor: darkTheme.accentColor,
                            backgroundColor: darkTheme.accentColor + '20',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3,
                        }, {
                            label: '‚ö° Lightning',
                            data: lightningData,
                            borderColor: '#FFD700',
                            backgroundColor: '#FFD70020',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                        }, {
                            label: 'üîó On-chain',
                            data: onchainData,
                            borderColor: '#FF6B35',
                            backgroundColor: '#FF6B3520',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                        }, {
                            label: 'üßä Cold Storage',
                            data: coldData,
                            borderColor: '#87CEEB',
                            backgroundColor: '#87CEEB20',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                        }, {
                            label: 'üíß Liquid (No Cold)',
                            data: liquidData,
                            borderColor: darkTheme.successColor,
                            backgroundColor: darkTheme.successColor + '20',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: darkTheme.gridColor,
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatSats(value);
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: darkTheme.gridColor,
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                backgroundColor: darkTheme.borderColor,
                                titleColor: darkTheme.textColor,
                                bodyColor: darkTheme.textColor,
                                borderColor: darkTheme.gridColor,
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${formatSats(context.parsed.y)}`;
                                    }
                                }
                            },
                            legend: {
                                labels: {
                                    color: darkTheme.textColor,
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart',
                        }
                    }
                });

                hideChartLoading('portfolioChart');
            } catch (error) {
                console.error('Failed to load portfolio chart:', error);
                hideChartLoading('portfolioChart');
            }
        }

        // Chart 2: Lightning Fees (Bar + Line Combo)
        async function createFeesChart() {
            try {
                showChartLoading('feesChart');

                const daysParam = currentFeesRange === 'all' ? '?days=all' : `?days=${currentFeesRange}`;
                const response = await fetch(`/api/lightning/fees${daysParam}`);
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
                }
                const result = await response.json();

                if (!result.success || !result.data) {
                    hideChartLoading('feesChart');
                    console.error('No fees data available:', result.error || 'Empty dataset');
                    return;
                }

                const ctx = document.getElementById('feesChart').getContext('2d');

                // Prepare data
                const chartData = result.data;
                const labels = chartData.labels || [];
                const dailyFees = chartData.datasets?.[0]?.data || [];

                // Calculate cumulative fees
                let cumulative = 0;
                const cumulativeFees = dailyFees.map(fee => cumulative += fee);

                // Destroy existing chart
                if (feesChart) {
                    feesChart.destroy();
                }

                feesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Daily Fees (sats)',
                            data: dailyFees,
                            backgroundColor: darkTheme.accentColor + '80',
                            borderColor: darkTheme.accentColor,
                            borderWidth: 1,
                            yAxisID: 'y',
                        }, {
                            label: 'Cumulative Fees',
                            data: cumulativeFees,
                            type: 'line',
                            borderColor: darkTheme.successColor,
                            backgroundColor: darkTheme.successColor + '20',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                grid: {
                                    color: darkTheme.gridColor,
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + ' sats';
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false,
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatSats(value);
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: darkTheme.gridColor,
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                backgroundColor: darkTheme.borderColor,
                                titleColor: darkTheme.textColor,
                                bodyColor: darkTheme.textColor,
                                borderColor: darkTheme.gridColor,
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            return `Daily Fees: ${context.parsed.y} sats`;
                                        } else {
                                            return `Cumulative: ${formatSats(context.parsed.y)}`;
                                        }
                                    }
                                }
                            },
                            legend: {
                                labels: {
                                    color: darkTheme.textColor,
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart',
                        }
                    }
                });

                hideChartLoading('feesChart');
            } catch (error) {
                console.error('Failed to load fees chart:', error);
                hideChartLoading('feesChart');
            }
        }

        // Chart 3: Forward Counts (Bar Chart)
        async function createForwardsChart() {
            try {
                showChartLoading('forwardsChart');

                const daysParam = currentForwardsRange === 'all' ? '?days=all' : `?days=${currentForwardsRange}`;
                const response = await fetch(`/api/lightning/forwards${daysParam}`);
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
                }
                const result = await response.json();

                if (!result.success || !result.data) {
                    hideChartLoading('forwardsChart');
                    console.error('No forwards data available:', result.error || 'Empty dataset');
                    return;
                }

                const ctx = document.getElementById('forwardsChart').getContext('2d');

                // Prepare data
                const chartData = result.data;
                const labels = chartData.labels || [];
                const forwardCounts = chartData.datasets?.[0]?.data || [];

                // Find high-volume days (above 75th percentile)
                const sorted = [...forwardCounts].sort((a, b) => a - b);
                const q3Index = Math.floor(sorted.length * 0.75);
                const highVolumeThreshold = sorted[q3Index] || 0;

                // Color bars based on volume
                const backgroundColors = forwardCounts.map(count =>
                    count >= highVolumeThreshold ? darkTheme.warningColor + '80' : darkTheme.accentColor + '80'
                );
                const borderColors = forwardCounts.map(count =>
                    count >= highVolumeThreshold ? darkTheme.warningColor : darkTheme.accentColor
                );

                // Destroy existing chart
                if (forwardsChart) {
                    forwardsChart.destroy();
                }

                forwardsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Forward Count',
                            data: forwardCounts,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: darkTheme.gridColor,
                                },
                                ticks: {
                                    stepSize: 1,
                                }
                            },
                            x: {
                                grid: {
                                    color: darkTheme.gridColor,
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                backgroundColor: darkTheme.borderColor,
                                titleColor: darkTheme.textColor,
                                bodyColor: darkTheme.textColor,
                                borderColor: darkTheme.gridColor,
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const count = context.parsed.y;
                                        const isHighVolume = count >= highVolumeThreshold;
                                        return `Forwards: ${count}${isHighVolume ? ' (High Volume)' : ''}`;
                                    }
                                }
                            },
                            legend: {
                                labels: {
                                    color: darkTheme.textColor,
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart',
                        }
                    }
                });

                hideChartLoading('forwardsChart');
            } catch (error) {
                console.error('Failed to load forwards chart:', error);
                hideChartLoading('forwardsChart');
            }
        }

        async function loadPortfolioData() {
            showLoading();

            // Initialize Chart.js if not already done
            if (!initializeChartDefaults()) {
                showError('Chart.js library failed to load');
                return;
            }

            // Load date ranges from storage and update button states
            loadDateRangesFromStorage();
            updateActiveButton('portfolio', currentPortfolioRange);
            updateActiveButton('fees', currentFeesRange);
            updateActiveButton('forwards', currentForwardsRange);

            try {
                const response = await fetch('/api/portfolio/current');
                const result = await response.json();

                if (!result.success) {
                    showError(result.error || 'Failed to load portfolio data');
                    return;
                }

                const data = result.data;

                // Update all sections
                updateCurrentBalances(data);
                updateLightningDetails(data);
                updateOnchainDetails(data);
                updateColdStorageDetails(data);

                // Load charts
                await Promise.all([
                    createPortfolioChart(),
                    createFeesChart(),
                    createForwardsChart()
                ]);

                // Hide status and show dashboard
                document.getElementById('status').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

            } catch (error) {
                showError(`Network error: ${error.message}`);
            }
        }

        // Event handlers for date range buttons
        function setupDateRangeHandlers() {
            // Portfolio chart buttons
            document.querySelectorAll('.portfolio-range.date-range-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const days = this.getAttribute('data-days');
                    const numDays = days === 'all' ? 'all' : parseInt(days);

                    currentPortfolioRange = numDays;
                    saveDateRangeToStorage(STORAGE_KEYS.PORTFOLIO_RANGE, days);
                    updateActiveButton('portfolio', days);
                    createPortfolioChart();
                });
            });

            // Fees chart buttons
            document.querySelectorAll('.fees-range.date-range-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const days = this.getAttribute('data-days');
                    const numDays = days === 'all' ? 'all' : parseInt(days);

                    currentFeesRange = numDays;
                    saveDateRangeToStorage(STORAGE_KEYS.FEES_RANGE, days);
                    updateActiveButton('fees', days);
                    createFeesChart();
                });
            });

            // Forwards chart buttons
            document.querySelectorAll('.forwards-range.date-range-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const days = this.getAttribute('data-days');
                    const numDays = days === 'all' ? 'all' : parseInt(days);

                    currentForwardsRange = numDays;
                    saveDateRangeToStorage(STORAGE_KEYS.FORWARDS_RANGE, days);
                    updateActiveButton('forwards', days);
                    createForwardsChart();
                });
            });
        }

        // Load data when page loads and set up event handlers
        document.addEventListener('DOMContentLoaded', function() {
            loadPortfolioData();
            setupDateRangeHandlers();
            document.getElementById('refreshBtn').addEventListener('click', loadPortfolioData);
            startAutoRefresh();
        });

        // Auto-refresh every 5 minutes, with visibility and unload management
        let refreshIntervalId = null;
        const REFRESH_INTERVAL_MS = 5 * 60 * 1000;

        function startAutoRefresh() {
            if (!refreshIntervalId) {
                refreshIntervalId = setInterval(loadPortfolioData, REFRESH_INTERVAL_MS);
            }
        }

        function stopAutoRefresh() {
            if (refreshIntervalId) {
                clearInterval(refreshIntervalId);
                refreshIntervalId = null;
            }
        }

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                loadPortfolioData();
                startAutoRefresh();
            }
        });

        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });

        // Load version info
        async function loadVersion() {
            try {
                const response = await fetch('/api/version');
                const data = await response.json();
                if (data.success && data.data.version) {
                    document.getElementById('version-info').textContent = `${data.data.version}`;
                } else {
                    document.getElementById('version-info').textContent = 'unknown';
                }
            } catch (error) {
                console.error('Failed to load version:', error);
                document.getElementById('version-info').textContent = 'unknown';
            }
        }

        // Load version on page load
        loadVersion();

        // Navigation function
        function showSection(sectionName, event) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            if (event && event.target) {
                event.target.classList.add('active');
                event.target.setAttribute('aria-selected', 'true');
            }

            // Show appropriate content or redirect
            switch(sectionName) {
                case 'dashboard':
                    // Already on dashboard - scroll to top to provide feedback
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    break;
                case 'lightning':
                    console.info('Lightning management page - would navigate to dedicated Lightning page');
                    break;
                case 'onchain':
                    console.info('On-chain management page - would navigate to onchain addresses page');
                    break;
                case 'offline':
                    console.info('Cold storage management page - would navigate to cold storage accounts page');
                    break;
                case 'analytics':
                    console.info('Analytics page - would navigate to dedicated analytics page');
                    break;
            }
        }
    </script>

    <!-- Version Footer -->
    <footer style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #30363d; color: #8b949e; font-size: 0.85em;">
        <div>
            Lightning Node Tools
            <span id="version-info">loading...</span>
        </div>
    </footer>
</body>
</html>
